# Hardened Nginx configuration for serving static SPA assets
server {
  listen 80 default_server;
  server_name _;

  # Health endpoint
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Runtime config (served as JS file)
  location /config/ {
    add_header Cache-Control "no-store";
  }

  # SPA fallback: always serve index.html for non-file paths
  location / {
    try_files $uri /index.html;
  }

  # Nginx stub_status for metrics exporter (restricted to localhost by default)
  location /stub_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
  }

  root /usr/share/nginx/html;

  # Security headers (basic set; CSP can be added if domains known)
  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options DENY always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy no-referrer-when-downgrade always;
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

  # Caching for static assets (hashed filenames)
  location ~* \.(?:js|css|woff2?|ttf|eot)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    try_files $uri =404;
  }

  # Images caching
  location ~* \.(?:png|jpg|jpeg|gif|svg|ico|webp)$ {
    add_header Cache-Control "public, max-age=2592000";
    try_files $uri =404;
  }
}
